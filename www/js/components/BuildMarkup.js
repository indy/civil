import { h } from '/lib/preact/mod.js';
import { useWasmInterface } from '/js/WasmInterfaceProvider.js';

// build the Preact structure from the AST generated by rust
//
export default function buildMarkup(content, imageDirectory) {
    const wasmInterface = useWasmInterface();
    const astArray = wasmInterface.asHtmlAst(content);

    function attrs(n) {
        const res = { key: n.key };
        if (n.class_name) { res.class = n.class_name; }
        if (n.id)         { res.id = n.id; }
        if (n.html_for)   { res.for = n.html_for; }
        if (n.href)       { res.href = n.href; }
        if (n.html_type)  { res.type = n.html_type; }
        if (n.src)        { res.src = `/u/${imageDirectory}/${n.src}`; }
        if (n.start)      { res.start = n.start; }

        return res;
    }

    function compile(n) {
        return n.name === "text" ? n.text : h(n.name, attrs(n), ...n.children.map(compile));
    }

    return astArray.map(compile);
}
